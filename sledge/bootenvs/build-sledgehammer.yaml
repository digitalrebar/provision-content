---
Name: "sledgehammer-install"
Description: "Install bootenv for building Sledgehammer images"
Documentation: |
  This BootEnv is used as the basis for building Sledgehammer, our in-memory discovery
  and inventory management environment.  This bootenv is reponsible for performing
  a basic CentOS install on a sacrificial machine.  The tasks that run after the install
  has finished are responsible for stripping out everything we do not need for Sledgehammer
  to boot as an in-memory OS image and packaging everything up for distribution.
Loaders:
  amd64-uefi: EFI/BOOT/BOOTX64.EFI
  arm64-uefi: EFI/BOOT/grubaa64.efi
OS:
  Family: "redhat"
  Name: "centos-7"
  SupportedArchitectures:
    x86_64:
      Kernel: "images/pxeboot/vmlinuz"
      Initrds:
        - "images/pxeboot/initrd.img"
      BootParams: >-
        ksdevice=bootif
        ks={{.Machine.Url}}/sledgehammer.ks
        method={{.Env.InstallUrl}}
        inst.geoloc=0
        --
        {{.Param "kernel-console"}}
    aarch64:
      Loader: "grubarm64.efi"
      Kernel: "images/pxeboot/vmlinuz"
      Initrds:
        - "images/pxeboot/initrd.img"
      BootParams: >-
        ksdevice=bootif
        ks={{.Machine.Url}}/sledgehammer.ks
        method={{.Env.InstallUrl}}
        inst.geoloc=0
        --
        {{.Param "kernel-console"}}
Templates:
  - ID: "default-pxelinux.tmpl"
    Name: "pxelinux"
    Path: "pxelinux.cfg/{{.Machine.HexAddress}}"
  - ID: "default-ipxe.tmpl"
    Name: "ipxe"
    Path: "{{.Machine.Address}}.ipxe"
  - ID: "default-pxelinux.tmpl"
    Name: "pxelinux-mac"
    Path: 'pxelinux.cfg/{{.Machine.MacAddr "pxelinux"}}'
  - ID: "default-ipxe.tmpl"
    Name: "ipxe-mac"
    Path: '{{.Machine.MacAddr "ipxe"}}.ipxe'
  - ID: "default-grub.tmpl"
    Name: "grub"
    Path: "grub/{{.Machine.Address}}.cfg"
  - ID: "default-grub.tmpl"
    Name: "grub-mac"
    Path: 'grub/{{.Machine.MacAddr "grub"}}.cfg'
  - ID: "default-grub.tmpl"
    Name: "grub-secure"
    Path: "sledgehammer/e21d2b7f079dfcbd2952dbc79d09a793cd8fe7da/grub.cfg-{{.Machine.HexAddress}}"
  - ID: "default-grub.tmpl"
    Name: "grub-secure-mac"
    Path: 'sledgehammer/e21d2b7f079dfcbd2952dbc79d09a793cd8fe7da/grub.cfg-{{.Machine.MacAddr "pxelinux"}}'
  - Name: "sledgehammer.ks"
    Path: "{{.Machine.Path}}/sledgehammer.ks"
    Contents: |
      lang en_US.UTF-8
      keyboard us
      timezone UTC
      auth --useshadow --enablemd5
      # rebar1
      rootpw --iscrypted $1$UwJdGUMy$ORqjDQIW//wt7sWY.xG9M0
      selinux --permissive
      firewall --disabled
      {{ if eq (.Param "sledgehammer/repo-location") "mirrorlist" -}}
      # using public mirrorlist for package repositories
      repo --name=os --mirrorlist=http://mirrorlist.centos.org/?release=$releasever&arch=$basearch&repo=os --cost=10
      repo --name=updates --mirrorlist=http://mirrorlist.centos.org/?release=$releasever&arch=$basearch&repo=updates --cost=10
      repo --name=centosplus --mirrorlist=http://mirrorlist.centos.org/?release=$releasever&arch=$basearch&repo=centosplus --cost=10
      repo --name=epel --baseurl=http://download.fedoraproject.org/pub/epel/$releasever/$basearch --cost=100
      {{ else if eq (.Param "sledgehammer/repo-location") "local" -}}
      # generating Macine Repos from package-repositories
      {{ range .MachineRepos -}}
      {{ .Install }}
      {{ end -}}
      {{ end -}}
      bootloader --location=mbr
      zerombr
      clearpart --all
      part /boot --fstype ext4 --size=512
      part /boot/efi --fstype vfat --size=512
      part / --fstype ext4 --size=1 --grow
      text
      poweroff
      %packages
      OpenIPMI
      OpenIPMI-tools
      aic94xx-firmware
      audit
      authconfig
      banner
      basesystem
      bash
      bsdtar
      bzip2
      coreutils
      cpio
      curl
      dhclient
      dmidecode
      dosfstools
      e2fsprogs
      efibootmgr
      file
      filesystem
      firewalld
      fuse
      fuse-libs
      fuse-ntfs-3g
      gdisk
      glibc
      gzip
      hostname
      initscripts
      iproute
      iprutils
      iptables
      iputils
      jq
      kbd
      kernel
      kernel-tools
      kernel-headers
      kernel-devel
      kexec-tools
      dkms
      less
      libsysfs
      linux-firmware
      lldpd
      lshw
      lvm2
      man-db
      mdadm
      {{if (eq .Machine.Arch "amd64")}}
      grub2-efi-x64
      shim-x64
      microcode_ctl
      {{end}}
      mktemp
      ncurses
      nfs-utils
      ntfs-3g
      ntfsprogs
      ntp
      openssh-clients
      openssh-server
      openssl-libs
      parted
      passwd
      pciutils
      policycoreutils
      procps-ng
      rootfiles
      rpm
      rsyslog
      selinux-policy-minimum
      setup
      shadow-utils
      squashfs-tools
      stress
      stress-ng
      sudo
      systemd
      systemd-resolved
      systemd-networkd
      tar
      unzip
      util-linux
      vim-enhanced
      wget
      which
      xfsdump
      xfsprogs
      xz
      yum
      zlib
      %end

      %pre
      {{ range $intf := .Param "sledgehammer/extra-ifs" }}
      dhclient --no-pid {{ $intf }}
      {{end}}
      %end

      %post
      cat >/etc/selinux/config <<EOF
      SELINUX=permissive
      SELINUXTYPE=minimum
      EOF
      {{template "reset-workflow.tmpl" .}}
      {{template "runner.tmpl" .}}

      {{ if eq (.Param "rs-debug-enable") true -}}
      while $(ls -l /wait-to-exit > /dev/null 2>&1 ) ; do echo "waiting ... (remove file '/wait-to-exit' to continue, or Ctl-C on system console)" > /dev/tty1; sleep 10; done
      {{ end -}}

      %end
