# Creates cloud-init behavior for Linode instances
# note: you can use public "stackscript_id = 863588" instead of generating the block each time
resource "linode_stackscript" "digitalrebar_join" {
  label       = "digitalrebar_join"
  description = "Managed by Digital Rebar Cloud Wrappers"
  images      = ["{{ .Param "linode/instance-image" }}"]
  rev_note    = "autogenerated"
  script      = <<-EOT
  #!/bin/bash
  # <UDF name="api_url" label="DRP Endpoint URL" />
  # v4.7 feature: place cloud-init for drpcli machines whoami
  tee /run/cloud-init/instance-data.json >/dev/null << EOF
  {
    "v1": {
      "region": "\$\${LINODE_DATACENTERID}",
      "cloud_name": "linode",
      "instance_id": "\$\${LINODE_ID}"
    },
    "variant": "digitalrebar",
    "vendordata": "rackn"
  }
  EOF
  curl -kfsSL \$\${API_URL}/machines/join-up.sh | sudo bash --
  EOT

  lifecycle {
    ignore_changes = all
  }
}
